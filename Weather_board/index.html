<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
</head>
<body>
    <div id="weatherContainer">
        <div id="weather"></div>
        <form id="cityForm">
            <input type="text" id="cityInput" placeholder="Enter city name">
            <button type="submit">Get weather</button>
            <p id="location">Location:</p>
            <p id="temperature">Temperature:</p>
            <p id="weatherDescription">Weather:</p>
            <p id="humidity">Humidity:</p>
            <p id="windSpeed">Wind Speed:</p>
        </form>
        <div id="graphContainer">
        </div>
    </div>
    <div id="mapContainer">
        <div id="sliderBar">
            <input type="range" id="zoomSlider" min="2" max="20" value="10" step="0.2">
            <p>Zoom: <span id="zoomValue">10</span></p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const platform = new H.service.Platform({
                apikey: 'XK5A-ktpolhuDh2J_f1bHGYKRC8E_AspFlvBbGC08lU'
            });
            const defaultLayers = platform.createDefaultLayers();
            const map = new H.Map(document.getElementById('mapContainer'), defaultLayers.vector.normal.map, {
                center: { lat: 51.5074, lng: -0.1278 }, // London coordinates
                zoom: 10,
                pixelRatio: window.devicePixelRatio || 1
            });

            document.getElementById('zoomSlider').addEventListener('input', function() {
                const zoomLevel = this.value;
                map.setZoom(zoomLevel);
                document.getElementById('zoomValue').innerText = zoomLevel;
            });
            const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
            const ui = H.ui.UI.createDefault(map, defaultLayers);

            document.getElementById('cityForm').addEventListener('submit', function(event) {
                event.preventDefault();

                // Constants
                const city = document.getElementById('cityInput').value;
                const apiKey = 'a2a826deef4e3d52990f039d7ffce1d8';
                const apiKey2 = 'XK5A-ktpolhuDh2J_f1bHGYKRC8E_AspFlvBbGC08lU';
                const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;
                const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric`;
                
                // Variables
                let hourly_temps = [];
                let hours = [];

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const weatherDiv = document.getElementById('weather');
                        let lat = data.coord.lat;
                        let long = data.coord.lon;

                        //Log the latitude and longitude so i can use the knockoff google maps later
                        console.log(lat,long);

                        hourly_temps.push(data.main.temp);
                        hours.push(data.dt);

                        document.getElementById('location').innerText = `Location: ${data.name}`;
                        document.getElementById('temperature').innerText = `Temperature: ${data.main.temp} °C`;
                        document.getElementById('weatherDescription').innerText = `Weather: ${data.weather[0].description}`;
                        document.getElementById('humidity').innerText = `Humidity: ${data.main.humidity}%`;
                        document.getElementById('windSpeed').innerText = `Wind Speed: ${data.wind.speed} m/s`;

                        map.setCenter({ lat: lat, lng: long });
                        map.setZoom(20);
                    })
                    .catch(error => {
                        console.error('Error fetching weather data:', error);
                        alert('Failed to fetch weather data. Please try again.');
                    });

                fetch(forecastUrl)
                    .then(response => response.json())
                    .then(data => {
                        const existingForecastDiv = document.getElementById('forecast');
                        if (existingForecastDiv) {
                            existingForecastDiv.remove();
                        }

                        const forecastDiv = document.createElement('div');
                        forecastDiv.id = 'forecast';
                        forecastDiv.innerHTML = '<h2>Hourly Forecast</h2>';
                        hours = [];

                        data.list.slice(0, 5).forEach(hourData => {
                            const date = new Date(hourData.dt * 1000);
                            const hour = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const temp = hourData.main.temp;
                            const description = hourData.weather[0].description;

                            hourly_temps.push(temp);
                            hours.push(hour);
                        });

                        // Log the arrays to console
                        console.log('Hourly temperatures:', hourly_temps);
                        console.log('Hours:', hours);

                        // Create and display the graph
                        const ctx = document.createElement('canvas');
                        ctx.id = 'weatherChart';
                        document.getElementById('graphContainer').appendChild(ctx);

                        const weatherChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: hours,
                                datasets: [{
                                    label: 'Temperature (°C)',
                                    data: hourly_temps,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        beginAtZero: true
                                    },
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching forecast data:', error);
                        alert('Failed to fetch forecast data. Please try again.');
                    });
            });
        });
    </script>
</body>
</html>
